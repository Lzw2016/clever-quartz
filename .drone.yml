# 跳过构建在Commit Message中添加 [CI SKIP]
kind: pipeline
name: 打包部署

clone:
  disable: true

steps:
  - name: 下载源代码
    image: docker:git
    commands:
      # - env
      - echo "### $DRONE_GIT_HTTP_URL -> $DRONE_BRANCH"
      - git clone $DRONE_GIT_HTTP_URL ./
      - git checkout $DRONE_BRANCH
    environment:
      test: '123456789'

  - name: 编译源代码
    image: maven:3.6.0-jdk-8-alpine
    volumes:
      - name: package-java
        path: /package-java
    commands:
      - env
      - mvn install -Dmaven.test.skip=true -Dmaven.javadoc.skip=true -B -V -Pdev --settings /package-java/Maven/settings.xml
      # - mvn deploy -Dmaven.test.skip=true -Dmaven.javadoc.skip=true -B -V -Pdev --settings /package-java/Maven/settings.xml
      # - cp -f clever-quartz-server/target/clever-quartz-server-*-SNAPSHOT.jar /package-java

  - name: 构建Docker镜像
    image: plugins/docker
    settings:
      # bip: true
      insecure: true
      registry: 192.168.159.136:5000
      repo: 192.168.159.136:5000/java-service/clever-quartz-server
      dockerfile: ./Dockerfile
      target: dev
      tags:
        - '0.0.1-SNAPSHOT'
      force_tag: true
      auto_tag: true
      auto_tag_suffix: ''

  - name: 启动Docker容器
    image: appleboy/drone-ssh
    settings:
      host: 192.168.159.136
      port: 22
      username:
        from_secret: SshUsername
      password:
        from_secret: SshPassword
      command_timeout: 300
      script:
        - echo "------------------< 停止容器 >------------------"
        - docker stop clever-quartz-server
        - echo "------------------< 删除容器 >------------------"
        - docker rm -v clever-quartz-server
        - echo "------------------< 删除旧镜像 >------------------"
        - docker rmi 192.168.159.136:5000/java-service/clever-quartz-server:0.0.1-SNAPSHOT
        - echo "------------------< 拉取新镜像 >------------------"
        - docker pull 192.168.159.136:5000/java-service/clever-quartz-server:0.0.1-SNAPSHOT
        - echo "------------------< 运行新镜像 >------------------"
        - docker run --name clever-quartz-server -d -p 9066:9066 192.168.159.136:5000/java-service/clever-quartz-server:0.0.1-SNAPSHOT
        - exit

volumes:
  # Java打包目录
  - name: package-java
    host:
      path: /opt/package/java

# -------------------------------------------------------------------------------------------------------------